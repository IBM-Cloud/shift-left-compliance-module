version: '2'
messages:
  $i18n: locales.yml
template:
  name: Roar Tekton Toolchain Template
  description: Toolchain template for creating the Roar Tekton testing environment
  required:
  - repo_cli_dev_plugin_test
  - privateWorker
  - DjangoToolCE
  - DjangoToolCF
  - DjangoToolK8
  - GoToolCE
  - GoToolCF
  - GoToolK8

toolchain:
  name: $env.toolchainName
services:
  repo_cli_dev_plugin_test:
    service_id: hostedgit
    parameters:
      repo_name: 'cli-dev-plugin-test'
      repo_url: 'https://github.ibm.com/arf/cli-dev-plugin-test'
      source_repo_url: 'https://github.ibm.com/arf/cli-dev-plugin-test'
      type: clone
      has_issues: false
      enable_traceability: false
      kind: pipeline
      branch: tektonroar
      private_repo: false

  DjangoToolCE:
    service_id: pipeline
    parameters:
      name: 'DjangoToolCE'
      label: Pipeline for testing deployment of the Django starter kit via Code Engine toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:DJANGO:no:noskip:{{testEnv}}:auth:create:toolCE'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t1
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
          #PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
          #PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
          #PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
          #PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
          #ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
          #  DOCKER_USERNAME: >
          #    $env.dockerUsername ? '{{dockerUsername}}' : ''
          #  DOCKER_PASSWORD: >
          #    $env.dockerPassword ? '{{dockerPassword}}' : ''

  DjangoToolCF:
    service_id: pipeline
    parameters:
      name: 'DjangoToolCF'
      label: Pipeline for testing deployment of the Django starter kit via Cloud Foundry toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:DJANGO:no:noskip:{{testEnv}}:auth:create:toolCF'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t2
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
          #PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
          #PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
          #PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
          #PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
          #ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
          #  DOCKER_USERNAME: >
          #    $env.dockerUsername ? '{{dockerUsername}}' : ''
          #  DOCKER_PASSWORD: >
          #    $env.dockerPassword ? '{{dockerPassword}}' : ''

  DjangoToolK8:
    service_id: pipeline
    parameters:
      name: 'DjangoToolK8'
      label: Pipeline for testing deployment of the Django starter kit via Helm toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:DJANGO:no:noskip:{{testEnv}}:auth:create:toolK8'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t3
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
#          PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
#          PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
#          PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
#          PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
#          ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
#          DOCKER_USERNAME: >
#            $env.dockerUsername ? '{{dockerUsername}}' : ''
#          DOCKER_PASSWORD: >
#            $env.dockerPassword ? '{{dockerPassword}}' : ''

  GoToolCE:
    service_id: pipeline
    parameters:
      name: 'GoToolCE'
      label: Pipeline for testing deployment of the Go starter kit via Code Engine toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:GO:no:noskip:{{testEnv}}:auth:create:toolCE'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t4
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
          #PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
          #PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
          #PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
          #PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
          #ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
          #  DOCKER_USERNAME: >
          #    $env.dockerUsername ? '{{dockerUsername}}' : ''
          #  DOCKER_PASSWORD: >
          #    $env.dockerPassword ? '{{dockerPassword}}' : ''

  GoToolCF:
    service_id: pipeline
    parameters:
      name: 'GoToolCF'
      label: Pipeline for testing deployment of the Go starter kit via Cloud Foundry toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:GO:no:noskip:{{testEnv}}:auth:create:toolCF'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t5
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
          #PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
          #PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
          #PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
          #PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
          #ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
          #  DOCKER_USERNAME: >
          #    $env.dockerUsername ? '{{dockerUsername}}' : ''
          #  DOCKER_PASSWORD: >
          #    $env.dockerPassword ? '{{dockerPassword}}' : ''

  GoToolK8:
    service_id: pipeline
    parameters:
      name: 'GoToolK8'
      label: Pipeline for testing deployment of the Go starter kit via Helm toolchain
      services:
        - repo_cli_dev_plugin_test
        - privateWorker
      type: tekton
      ui-pipeline: true
      execute: manual-run
      configuration:
        content:
          $text: tekton_config.yml
        env:
          TEST_NAME: 'django:app:GO:no:noskip:{{testEnv}}:auth:create:toolK8'
          API_KEY: '{{form.pipeline.parameters.api-key}}'
          API_URL: 'https://cloud.ibm.com'
          APPNAME_PREFIX: t6
          ART_API_KEY: '{{form.pipeline.parameters.art-api-key}}'
          CLUSTER_NAME: 'tektonroar{{testEnv}}'
          CR_NAMESPACE: arftt_namespace
          GIT_REPO: repo_cli_dev_plugin_test
          GIT_URL: '{{services.repo_cli_dev_plugin_test.parameters.source_repo_url}}'
          GITLAB_TOKEN: '{{form.pipeline.parameters.gitlab-token}}'
          GITLAB_USER: arftt
          LOGS_DIR: '/workspace/ROAR'
          ORG: 'arftt@us.ibm.com'
          PASSPHRASE: 'None'
          PERSONAL_YAAS: 'None'
          REGION: 'us-south'
          REPO_COMMIT_EVENT_LISTENER_NAME: 'listener'
          REPOSITORY: repo_cli_dev_plugin_test
          RESOURCE_GROUP: 'default'
          REVISION: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          SLACK_URL: '{{form.pipeline.parameters.slack-webhook}}'
          SPACE: 'test'
          TEST_DIR: '/workspace/testFiles'
          PRIVATE_WORKER: '{{services.privateWorker.parameters.name}}'
#          PAGERDUTY_API_URL: 'https://api.pagerduty.com/'
#          PAGERDUTY_EVENTS_API_URL: 'https://events.pagerduty.com/v2/enqueue'
#          PAGERDUTY_API_TOKEN: '{{form.pipeline.parameters.pagerduty-api-token}}'
#          PAGERDUTY_SVC_NAME: '{{form.pipeline.parameters.pagerduty-service-name}}'
#          ENABLE_PD_ALERTS: '{{form.pipeline.parameters.enable-pd-alerts}}'
          PIPELINE_REPO: repo_cli_dev_plugin_test
          PIPELINE_REPO_BRANCH: '{{services.repo_cli_dev_plugin_test.parameters.branch}}'
          GIT_COMMIT_EVENT_LISTENER_NAME: >
            if ( $env.source_provider === 'githubconsolidated' ) {
              'github-commit';
            } else if ( $env.source_provider === 'gitlab' ) {
              'grit-or-gitlab-commit';
            } else if ( $env.source_provider === 'bitbucketgit' ) {
              'bitbucket-commit';
            } else if ( $env.source_provider === 'github_integrated' ) {
              'github-ent-commit';
            } else {
              'grit-or-gitlab-commit';
            }
#          DOCKER_USERNAME: >
#            $env.dockerUsername ? '{{dockerUsername}}' : ''
#          DOCKER_PASSWORD: >
#            $env.dockerPassword ? '{{dockerPassword}}' : ''

  sm-vault:
    service_id: secretsmanager
    parameters:
      name: >
        $env.smName ? '{{smName}}' : 'sm-compliance-secrets'
      region: >
        $env.smRegion ? '{{smRegion}}' : ''
      resource-group: >
        $env.smResourceGroup ? '{{smResourceGroup}}' : ''
      instance-name: >
        $env.smInstanceName ? '{{smInstanceName}}' : ''

  privateWorker:
    service_id: private_worker
    parameters:
      name: "{{form.private_worker.parameters.name}}"
      workerQueueCredentials: "{{form.private_worker.parameters.workerQueueCredentials}}"
      #workerQueueIdentifier: "{{form.private_worker.parameters.workerQueueIdentifier}}"

#  slack-roar-testing:
#    service_id: slack
#    parameters:
#      api_token: '{{form.pipeline.parameters.devx-slack-channel-webhook}}'
#      channel_name: >
#        if ( {{testEnv}} === 'prod' ) {
#          'devx-cli-tests-prod'
#        } else {
#          'devx-cli-tests-ondeck'
#        }
#      team_url: 'ibm-cloudplatform'
#      pipeline_start: false
#      pipeline_success: false
#      pipeline_fail: true

#  devops-insights:
#      service_id: draservicebroker

form:
  pipeline:
    parameters:
      api-key: '{{apiKey}}'
      art-api-key: '{{artApiKey}}'
      gitlab-token: '{{gitLabToken}}'
      git-template-repo: '{{repository}}'
      git-template-branch: '{{branch}}'
      slack-webhook: '{{slackWebhook}}'
#      pagerduty-api-token: '{{pagerDutyAPIToken}}'
#      pagerduty-service-name: '{{pagerDutySvcName}}'
#      enable-pd-alerts: "$env.enablePDAlerts === 'true'"
    schema:
      $ref: deploy.json

  private_worker:
    parameters:
      name: '{{privateWorkerName}}'
      workerQueueCredentials: '{{privateWorkerCreds}}'
      # this wont be needed once a fix is in place for https://github.ibm.com/org-ids/roadmap/issues/15360
      workerQueueIdentifier: "{{privateWorkerIdentifier}}"
    schema:
      $ref: privateWorker.json

